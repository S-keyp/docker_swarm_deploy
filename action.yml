name: docker-swarm-deploy
author: Skeyp
description: A GitHub Action that enables you to publish your app as a Docker stack to a remote Docker swarm.
on:
  workflow_dispatch:
    inputs:
      docker_username:
        description: The docker user repository to push and pull to/from
        required: true
      docker_api_key:
        description: The docker api key associated with the docker user
        required: true
      remote_host:
        description: Remote host to connect to
        required: true
      remote_user:
        description: Remote user to use
        required: true
      remote_port:
        description: Remote port to use
        required: true
      ssh_private_key:
        description: SSH private key to use to connect
        required: true
      ssh_known_hosts:
        description: SSH-ed25519 key 
        required: true
      stack_name:
        description: The name of your stack in the swarm
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master'
    steps:
        - name: Login to Docker hub
          uses: docker/login-action@v3
          with:
              username: ${{ inputs.docker_username }}
              password: ${{ inputs.docker_api_key }}

        - name: Create private key
          env:
              REMOTE_HOST: ${{ inputs.remote_host }}
              REMOTE_USER: ${{ inputs.remote_user }}
              REMOTE_PORT: ${{ inputs.remote_port }}
              SSH_PRIVATE_KEY: ${{ inputs.ssh_private_key }}
              SSH_KNOWN_HOSTS: ${{ inputs.ssh_known_hosts }}
              STACK_NAME: ${{ inputs.stack_name }}
              
          run: |
              mkdir -p ~/.ssh/
              echo "$SSH_PRIVATE_KEY" >  ~/.ssh/private.key
              sudo chmod 600  ~/.ssh/private.key
              printf "Host docker
                  HostName $SSH_HOST
                  User $SERVER_USER
                  Port $SERVER_PORT
                  IdentityFile ~/.ssh/private.key" > ~/.ssh/config
              printf "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts

              echo "ssh config:"
              cat ~/.ssh/config
              
              echo "know hosts:"
              cat ~/.ssh/known_hosts

          shell: bash

        - name: Create Docker Context
          run: |
              docker context create docker --docker "host=ssh://docker"
              docker context use docker

        # allows checkout for the sole docker-compose file we need
        - uses: actions/checkout@v4
          with:
              sparse-checkout: |
                  compose.yml
              sparse-checkout-cone-mode: false

        - name: Deploy to server
          run: |
              docker stack deploy --compose-file compose.yml --with-registry-auth --prune $STACK_NAME

